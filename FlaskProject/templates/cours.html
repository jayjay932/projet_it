<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de Bord</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style_dashboard.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style_nav.css') }}">
</head>
<body>

    {% include 'nav.html' %}

    <div class="container-fluid">
        <div class="row">
            <!-- Barre lat√©rale -->
            <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="{{ url_for('cours') }}">Formations disponibles</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('mes_formations') }}">Mes Formations</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('edit_user_apprenant', user_id=current_user.id) }}">Modifier mes informations</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Contenu principal -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <h2 class="text-secondary mb-4">Formations disponibles</h2>

                <form method="GET" action="{{ url_for('cours') }}" class="mb-4">
                    <div class="row">
                        <div class="col-md-4">
                            <label for="domain" class="form-label">Domaine</label>
                            <select id="domain" name="domain" class="form-select">
                                <option value="" {% if not selected_domain %}selected{% endif %}>Tous les domaines</option>
                                <option value="D√©veloppement Web" {% if selected_domain == 'D√©veloppement Web' %}selected{% endif %}>D√©veloppement Web</option>
                                <option value="Intelligence Artificielle" {% if selected_domain == 'Intelligence Artificielle' %}selected{% endif %}>Intelligence Artificielle</option>
                                <option value="Finance et Comptabilit√©" {% if selected_domain == 'Finance et Comptabilit√©' %}selected{% endif %}>Finance et Comptabilit√©</option>
                                <option value="Marketing Digital" {% if selected_domain == 'Marketing Digital' %}selected{% endif %}>Marketing Digital</option>
                                <option value="Sant√© et Bien-√™tre" {% if selected_domain == 'Sant√© et Bien-√™tre' %}selected{% endif %}>Sant√© et Bien-√™tre</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="type" class="form-label">Type</label>
                            <select id="type" name="type" class="form-select">
                                <option value="" {% if not selected_type %}selected{% endif %}>Tous les types</option>
                                <option value="video" {% if selected_type == 'video' %}selected{% endif %}>Vid√©o</option>
                                <option value="pdf" {% if selected_type == 'pdf' %}selected{% endif %}>PDF</option>
                            </select>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">Trier</button>
                        </div>
                    </div>
                </form>

                <div class="row">
                    {% if formations %}
                        {% for formation in formations %}
                            {% if formation.id not in selected_formation_ids %}
                                <div class="col-md-6 col-lg-4 mb-4">
                                    <div class="card shadow-sm h-100">
                                        {% if formation.type == 'video' %}
                                            <div class="ratio ratio-16x9">
                                                <img src="https://img.youtube.com/vi/{{ formation.link.split('v=')[1] }}/hqdefault.jpg" alt="Miniature" class="img-fluid">
                                            </div>
                                            <div class="card-body">
                                                <h3 class="card-title text-dark">{{ formation.title }}</h3>
                                                <p class="card-text text-muted">{{ formation.description }}</p>
                                                <p class="card-text"><strong>Domaine :</strong> {{ formation.domain }}</p>
                                                <p class="card-text"><strong>Dur√©e :</strong> {{ formation.duree or 'Non sp√©cifi√©e' }}</p>
                                                <form method="POST" action="{{ url_for('select_formation', formation_id=formation.id) }}">
                                                    <button type="submit" class="btn btn-primary w-100">S√©lectionner</button>
                                                </form>
                                            </div>
                                        {% elif formation.type == 'pdf' %}
                                            <div class="card-body">
                                                <h3 class="card-title text-dark">{{ formation.title }}</h3>
                                                <p class="card-text text-muted">{{ formation.description }}</p>
                                                <p class="card-text"><strong>Domaine :</strong> {{ formation.domain }}</p>
                                                <p class="card-text"><strong>Taille :</strong>
                                                    {% if formation.taille %}
                                                        {{ '%.2f' | format(formation.taille | float) }} Mo
                                                    {% else %}
                                                        Non sp√©cifi√©e
                                                    {% endif %}
                                                </p>
                                                <form method="POST" action="{{ url_for('select_formation', formation_id=formation.id) }}">
                                                    <button type="submit" class="btn btn-primary w-100">S√©lectionner</button>
                                                </form>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <p class="text-muted">Aucune formation n'est disponible pour le moment.</p>
                    {% endif %}
                </div>
            </main>
        </div>
    </div>

    {% include 'footer.html' %}

    <!-- ChatBot -->
    <img src="https://cdn-icons-png.flaticon.com/512/4712/4712100.png" alt="ChatBot" id="chatbot-logo" onclick="toggleChatbot()" />
    <div id="chatbot-window">
        <div id="chatbot-header">üí¨ Assistant √âcologique</div>
        <div id="chatbot-messages"></div>
        <div style="display: flex;">
            <input type="text" id="chatbot-input" placeholder="Pose ta question..." />
            <button onclick="sendChatbotMessage()">Envoyer</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        function toggleChatbot() {
            const chatWindow = document.getElementById("chatbot-window");
            chatWindow.style.display = chatWindow.style.display === "none" ? "flex" : "none";
        }

        function sendChatbotMessage() {
            const input = document.getElementById("chatbot-input");
            const message = input.value.trim();
            if (!message) return;

            const messagesDiv = document.getElementById("chatbot-messages");
            messagesDiv.innerHTML += `<div class='message user'><strong>Vous:</strong> ${message}</div>`;
            input.value = "";

            fetch("/chat", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ message: message })
            })
            .then(response => response.json())
            .then(data => {
                const responseHtml = `<div class='message bot'><strong>Bot:</strong><br>${data.response}</div>`;
                messagesDiv.innerHTML += responseHtml;
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            });
        }
    </script>

</body>
</html>
